## X68000Z EAK 1.1.3 における SCC Tx buffer Empty に関する考察

### はじめに

本ドキュメントは X68000Z EAK 1.1.3 エミュレータモードにおける SCC Tx buffer Empty ビットの挙動、および 31250bps SCC時定数に関する挙動について、当方のfindingを共有させて頂くものです。内容についてはすべて予測の範囲でしかありませんが、今後の株式会社瑞起様によるZエミュレータ更新の一助になれば幸いです。

2023.04.22 tantan

---

### EAK 1.1.3 での SCC Tx buffer Empty に関する挙動の実機との違いと、それに伴う影響

確認環境(X68000Z)：
- X68000Z EAK 1.1.3 エミュレータモード Human68k 3.02 RSDRV あり・なし

確認環境(実機):
- X68000XVI 10MHz Human68k 3.02 RSDRV あり・なし

同じXDFイメージを使用して確認。XVIはXDFを実FDに書き出したものを使用。


実機との明らかな差異:
- SCC Ch.A $E98005 RR0 レジスタ bit2 Tx buffer Empty が 0 になる(=バッファにキャラクタがある)頻度が実機と比較して明らかに高い。

これによる影響:
- IOCSコール _OSNS232C や $E98005 から RR0 の bit2 を直接読み出して送信可能(ビットが1)であることを確認してからデータを送信するのが一般的な作法であるが、既存のソフトウェアによってはここまで高頻度で送信不可状態になることを想定していないものがある。

動作しないソフトの例:
- RCD.X RS-MIDIモード (MIDI音源ドライバ)
- PPP.X (PPP接続クライアント)

ソフトウェア側での暫定パッチ対応例:
- 厳密に bit2 が 0 になるのを待つか、もしくは 0 の場合であっても構わず送信してしまう(これでも問題はほぼ起きないように見えます)

修正の提案：
- おそらく、ARM Linux上でのUARTドライバと整合させた上での厳密な挙動なのかとは思いますが、もう少し緩くして送信を受け付ける状態にしてもらえると、パッチなしで動作するソフトも増えると思います。

---

### EAK 1.1.3 での SCC 31250bps 不可に関して

もう1点 SCC に関連してですが、特に MIDI 音源ドライバについては、MIDI 標準のボーレートである 31250bps を用いるものがあります。(RCD.X, MIDDRV.X等)
現状の EAK Zエミュレータの実装を見ると、このようなSCC時定数を設定しても 38400bps に繰り上げられてしまっているように見えます(勘違いでしたらすみません)。

できれば 31250bps についてはそのまま31250bpsとしてサポートして頂けると、対応できる RS-MIDI ドライバや MIDI機器も増えるものと思います。


以上2点ご報告させて頂きます。

tantan 2023.04.22